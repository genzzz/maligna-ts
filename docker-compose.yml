# Docker Compose for mALIGNa
# Provides convenient service definitions for different use cases

services:
  # Main service - interactive shell for alignment tasks
  maligna:
    build:
      context: .
      dockerfile: Dockerfile
    image: maligna:latest
    container_name: maligna
    volumes:
      # Mount local data directory for input/output files
      - ./data:/data
      # Mount examples as read-only reference
      - ./maligna-ui/examples:/examples:ro
    working_dir: /data
    stdin_open: true
    tty: true

  # Example 1: Basic alignment with Viterbi algorithm
  example1:
    build:
      context: .
      dockerfile: Dockerfile
    image: maligna:latest
    volumes:
      - ./maligna-ui/examples:/examples:ro
      - ./output:/data
    working_dir: /data
    command: >
      bash -c "
        maligna parse -c txt /examples/txt/poznan-pl.txt /examples/txt/poznan-de.txt |
        maligna modify -c split-sentence |
        maligna modify -c trim |
        maligna align -c viterbi -a normal -n char -s iterative-band |
        maligna select -c one-to-one |
        maligna format -c txt poznan-pl-align.txt poznan-de-align.txt &&
        echo 'Example 1 completed! Output files: poznan-pl-align.txt, poznan-de-align.txt'
      "

  # Example 2: Moore's algorithm (multi-step alignment)
  example2-step1:
    build:
      context: .
      dockerfile: Dockerfile
    image: maligna:latest
    volumes:
      - ./maligna-ui/examples:/examples:ro
      - ./output:/data
    working_dir: /data
    command: >
      bash -c "
        maligna parse -c txt /examples/txt/poznan-pl.txt /examples/txt/poznan-de.txt |
        maligna modify -c split-sentence |
        maligna modify -c trim > poznan-split.al &&
        echo 'Step 1 completed: poznan-split.al created'
      "

  example2-step2:
    build:
      context: .
      dockerfile: Dockerfile
    image: maligna:latest
    volumes:
      - ./output:/data
    working_dir: /data
    command: >
      bash -c "
        cat poznan-split.al |
        maligna align -c fb -a poisson -n word -s iterative-band |
        maligna select -c one-to-one |
        maligna select -c fraction -f 0.85 > poznan-align-length.al &&
        echo 'Step 2 completed: poznan-align-length.al created'
      "

  example2-step3:
    build:
      context: .
      dockerfile: Dockerfile
    image: maligna:latest
    volumes:
      - ./output:/data
    working_dir: /data
    command: >
      bash -c "
        cat poznan-split.al |
        maligna align -c fb -a poisson,translation -n word -s iterative-band -t poznan-align-length.al > poznan-align.al &&
        echo 'Step 3 completed: poznan-align.al created'
      "

  # Run all Moore's algorithm steps sequentially
  example2-full:
    build:
      context: .
      dockerfile: Dockerfile
    image: maligna:latest
    volumes:
      - ./maligna-ui/examples:/examples:ro
      - ./output:/data
    working_dir: /data
    command: >
      bash -c "
        echo '=== Step 1: Split and trim ===' &&
        maligna parse -c txt /examples/txt/poznan-pl.txt /examples/txt/poznan-de.txt |
        maligna modify -c split-sentence |
        maligna modify -c trim > poznan-split.al &&
        
        echo '=== Step 2: Length-based alignment ===' &&
        cat poznan-split.al |
        maligna align -c fb -a poisson -n word -s iterative-band |
        maligna select -c one-to-one |
        maligna select -c fraction -f 0.85 > poznan-align-length.al &&
        
        echo '=== Step 3: Translation-based alignment ===' &&
        cat poznan-split.al |
        maligna align -c fb -a poisson,translation -n word -s iterative-band -t poznan-align-length.al > poznan-align.al &&
        
        echo '=== Moore algorithm completed! ===' &&
        echo 'Output files: poznan-split.al, poznan-align-length.al, poznan-align.al'
      "

  # Example 3: Oracle alignment
  example3:
    build:
      context: .
      dockerfile: Dockerfile
    image: maligna:latest
    volumes:
      - ./maligna-ui/examples:/examples:ro
      - ./output:/data
    working_dir: /data
    command: >
      bash -c "
        maligna parse -c txt /examples/txt/poznan-pl.txt /examples/txt/poznan-de.txt |
        maligna modify -c split-sentence |
        maligna modify -c trim |
        maligna align -c viterbi -a oracle,normal -d /examples/align/human/poznan-oracle.al -n char -s iterative-band > poznan-oracle.al &&
        echo 'Example 3 completed! Output file: poznan-oracle.al'
      "

  # Help command
  help:
    build:
      context: .
      dockerfile: Dockerfile
    image: maligna:latest
    command: ["maligna", "-h"]
